@model AppointmentViewModel

@{
    ViewData["Title"] = "New Appointment";
}

<h1 style="margin-bottom:32px;">New Appointment</h1>

<div style="max-width:600px;">
    <form asp-action="Create" method="post">
        @if(ViewData.ModelState.ErrorCount > 0){
            <div asp-validation-summary="All" class="error" style="padding:12px; background:#ffebee; border:1px solid #ef5350; border-radius:6px; margin-bottom:20px;"></div>
        }
        
        @if (User.IsInRole("Admin"))
        {
            <label asp-for="GymId">Gym</label>
            <select asp-for="GymId" id="GymId">
                <option value="">-- Select Gym --</option>
                @if (ViewBag.Gyms != null)
                {
                    var gyms = ViewBag.Gyms as IEnumerable<GymViewModel>;
                    if (gyms != null)
                    {
                        @foreach (var gym in gyms)
                        {
                            <option value="@gym.GymId">@gym.Name</option>
                        }
                    }
                }
            </select>
            <span asp-validation-for="GymId" class="error"></span>
        }
        
        <label asp-for="Date">Appointment Date</label>
        <input asp-for="Date" type="date" />
        <span asp-validation-for="Date" class="error"></span>
        
        <label asp-for="Time">Appointment Time</label>
        <input asp-for="Time" type="time" />
        <span asp-validation-for="Time" class="error"></span>
        
        <label asp-for="UserId">Member</label>
        <select asp-for="UserId">
            <option value="">-- Select Member --</option>
            @if (ViewBag.Users != null)
            {
                var users = ViewBag.Users as IEnumerable<UserViewModel>;
                if (users != null)
                {
                    @foreach (var user in users)
                    {
                        <option value="@user.Id">@user.UserName (@user.Email)</option>
                    }
                }
            }
        </select>
        <span asp-validation-for="UserId" class="error"></span>
        
        <label asp-for="TrainerId">Trainer</label>
        <select asp-for="TrainerId">
            <option value="">-- Select Trainer --</option>
            @if (ViewBag.Trainers != null)
            {
                var trainers = ViewBag.Trainers as IEnumerable<UserViewModel>;
                if (trainers != null)
                {
                    @foreach (var trainer in trainers)
                    {
                        <option value="@trainer.Id">@trainer.UserName - @trainer.GymName</option>
                    }
                }
            }
        </select>
        <span asp-validation-for="TrainerId" class="error"></span>
        
        <label asp-for="ServiceId">Service</label>
        <select asp-for="ServiceId" id="ServiceId">
            @if (User.IsInRole("Admin"))
            {
                <option value="">-- Select Gym First --</option>
            }
            else if (User.IsInRole("Trainer"))
            {
                <option value="">-- Select Service --</option>
                @if (ViewBag.Services != null)
                {
                    var services = ViewBag.Services as IEnumerable<ServiceViewModel>;
                    if (services != null)
                    {
                        @foreach (var service in services)
                        {
                            <option value="@service.ServiceId">@service.Name - @service.Price.ToString("C2")</option>
                        }
                    }
                }
            }
        </select>
        <span asp-validation-for="ServiceId" class="error"></span>
        
        <div style="margin-top:24px;">
            <button type="submit">Create Appointment</button>
            <a class="btn-secondary" asp-action="Index">Cancel</a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        document.getElementById('GymId')?.addEventListener('change', function() {
            const gymId = this.value;
            const serviceSelect = document.getElementById('ServiceId');
            
            if (!gymId) {
                serviceSelect.innerHTML = '<option value="">-- Select Gym First --</option>';
                return;
            }
            
            fetch(`/Services/GetByGym?gymId=${gymId}`)
            .then(response => response.json())
            .then(services => {
                serviceSelect.innerHTML = '<option value="">-- Select Service --</option>';
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.serviceId;
                    option.textContent = `${service.name} - $${service.price.toFixed(2)}`;
                    serviceSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading services:', error);
                serviceSelect.innerHTML = '<option value="">Error loading services</option>';
            });
        });
    </script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
