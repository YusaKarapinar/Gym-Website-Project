@model AppointmentViewModel

@{
    ViewData["Title"] = "Yeni Randevu Oluştur";
}

<div class="text-center py-4 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="container text-white">
        <h1 class="display-5 fw-bold mb-2">
            <i class="fas fa-calendar-plus"></i> Yeni Randevu Oluştur
        </h1>
        <p class="lead mb-0">Randevu detaylarını girin</p>
    </div>
</div>

<div class="container">
    <div class="card shadow-sm">
        <div class="card-body">
            <form asp-action="Create" method="post">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                
                @if (User.IsInRole("Admin"))
                {
                    <div class="mb-3">
                        <label for="GymId" class="form-label">
                            <i class="fas fa-building"></i> Spor Salonu
                        </label>
                        <select asp-for="GymId" class="form-select" id="GymId">
                            <option value="">-- Salon Seçin --</option>
                            @if (ViewBag.Gyms != null)
                            {
                                var gyms = ViewBag.Gyms as IEnumerable<GymViewModel>;
                                if (gyms != null)
                                {
                                    @foreach (var gym in gyms)
                                    {
                                        <option value="@gym.GymId">@gym.Name</option>
                                    }
                                }
                            }
                        </select>
                        <span asp-validation-for="GymId" class="text-danger"></span>
                    </div>
                }
                
                <div class="mb-3">
                    <label asp-for="Date" class="form-label">
                        <i class="fas fa-calendar"></i> Randevu Tarihi
                    </label>
                    <input asp-for="Date" type="date" class="form-control" />
                    <span asp-validation-for="Date" class="text-danger"></span>
                </div>
                
                <div class="mb-3">
                    <label asp-for="Time" class="form-label">
                        <i class="fas fa-clock"></i> Randevu Saati
                    </label>
                    <input asp-for="Time" type="time" class="form-control" />
                    <span asp-validation-for="Time" class="text-danger"></span>
                </div>
                
                <div class="mb-3">
                    <label asp-for="UserId" class="form-label">
                        <i class="fas fa-user"></i> Üye
                    </label>
                    <select asp-for="UserId" class="form-select">
                        <option value="">-- Üye Seçin --</option>
                        @if (ViewBag.Users != null)
                        {
                            var users = ViewBag.Users as IEnumerable<UserViewModel>;
                            if (users != null)
                            {
                                @foreach (var user in users)
                                {
                                    <option value="@user.Id">@user.UserName (@user.Email)</option>
                                }
                            }
                        }
                    </select>
                    <span asp-validation-for="UserId" class="text-danger"></span>
                </div>
                
                <div class="mb-3">
                    <label asp-for="TrainerId" class="form-label">
                        <i class="fas fa-user-tie"></i> Eğitmen
                    </label>
                    <select asp-for="TrainerId" class="form-select">
                        <option value="">-- Eğitmen Seçin --</option>
                        @if (ViewBag.Trainers != null)
                        {
                            var trainers = ViewBag.Trainers as IEnumerable<UserViewModel>;
                            if (trainers != null)
                            {
                                @foreach (var trainer in trainers)
                                {
                                    <option value="@trainer.Id">@trainer.UserName - @trainer.GymName</option>
                                }
                            }
                        }
                    </select>
                    <span asp-validation-for="TrainerId" class="text-danger"></span>
                </div>
                
                <div class="mb-3">
                    <label asp-for="ServiceId" class="form-label">
                        <i class="fas fa-concierge-bell"></i> Hizmet
                    </label>
                    <select asp-for="ServiceId" class="form-select" id="ServiceId">
                        @if (User.IsInRole("Admin"))
                        {
                            <option value="">-- Önce Salon Seçin --</option>
                        }
                        else if (User.IsInRole("Trainer"))
                        {
                            <option value="">-- Hizmet Seçin --</option>
                            @if (ViewBag.Services != null)
                            {
                                var services = ViewBag.Services as IEnumerable<ServiceViewModel>;
                                if (services != null)
                                {
                                    @foreach (var service in services)
                                    {
                                        <option value="@service.ServiceId">@service.Name - @service.Price.ToString("F2") TL</option>
                                    }
                                }
                            }
                        }
                    </select>
                    <span asp-validation-for="ServiceId" class="text-danger"></span>
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-times"></i> İptal
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Gym seçildiğinde services'i yükle
        document.getElementById('GymId')?.addEventListener('change', function() {
            const gymId = this.value;
            const serviceSelect = document.getElementById('ServiceId');
            
            if (!gymId) {
                serviceSelect.innerHTML = '<option value="">-- Önce Salon Seçin --</option>';
                return;
            }
            
            fetch(`/Services/GetByGym?gymId=${gymId}`)
            .then(response => response.json())
            .then(services => {
                serviceSelect.innerHTML = '<option value="">-- Hizmet Seçin --</option>';
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.serviceId;
                    option.textContent = `${service.name} - ${service.price.toFixed(2)} TL`;
                    serviceSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading services:', error);
                serviceSelect.innerHTML = '<option value="">Hizmetler yüklenemedi</option>';
            });
        });
    </script>
}
