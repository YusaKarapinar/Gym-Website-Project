@model AppointmentViewModel

@{
    ViewData["Title"] = "New Appointment";
}

<h1 style="margin-bottom:32px;">New Appointment</h1>

<div style="max-width:600px;">
    <form asp-action="Create" method="post">
        @if(ViewData.ModelState.ErrorCount > 0){
            <div asp-validation-summary="All" class="error" style="padding:12px; background:#ffebee; border:1px solid #ef5350; border-radius:6px; margin-bottom:20px;"></div>
        }
        
        @if (User.IsInRole("Admin"))
        {
            <label asp-for="GymId">Gym</label>
            <select asp-for="GymId" id="GymId">
                <option value="">-- Select Gym --</option>
                @if (ViewBag.Gyms != null)
                {
                    var gyms = ViewBag.Gyms as IEnumerable<GymViewModel>;
                    if (gyms != null)
                    {
                        @foreach (var gym in gyms)
                        {
                            <option value="@gym.GymId">@gym.Name</option>
                        }
                    }
                }
            </select>
            <span asp-validation-for="GymId" class="error"></span>
        }
        
        <label asp-for="Date">Appointment Date</label>
        <input asp-for="Date" type="date" />
                    <span asp-validation-for="Date" class="text-danger"></span>
                </div>
                
                <div class="mb-3">
                    <label asp-for="Time" class="form-label">
                        <i class="fas fa-clock"></i> Randevu Saati
                    </label>
                    <input asp-for="Time" type="time" class="form-control" />
                    <span asp-validation-for="Time" class="text-danger"></span>
                </div>
                
                <div class="mb-3">
                    <label asp-for="UserId" class="form-label">
                        <i class="fas fa-user"></i> Üye
                    </label>
                    <select asp-for="UserId" class="form-select">
                        <option value="">-- Üye Seçin --</option>
                        @if (ViewBag.Users != null)
                        {
                            var users = ViewBag.Users as IEnumerable<UserViewModel>;
                            if (users != null)
                            {
                                @foreach (var user in users)
                                {
                                    <option value="@user.Id">@user.UserName (@user.Email)</option>
                                }
                            }
                        }
                    </select>
                    <span asp-validation-for="UserId" class="text-danger"></span>
                </div>
                
                <div class="mb-3">
                    <label asp-for="TrainerId" class="form-label">
                        <i class="fas fa-user-tie"></i> Eğitmen
                    </label>
                    <select asp-for="TrainerId" class="form-select">
                        <option value="">-- Eğitmen Seçin --</option>
                        @if (ViewBag.Trainers != null)
                        {
                            var trainers = ViewBag.Trainers as IEnumerable<UserViewModel>;
                            if (trainers != null)
                            {
                                @foreach (var trainer in trainers)
                                {
                                    <option value="@trainer.Id">@trainer.UserName - @trainer.GymName</option>
                                }
                            }
                        }
                    </select>
                    <span asp-validation-for="TrainerId" class="text-danger"></span>
                </div>
                
                <div class="mb-3">
                    <label asp-for="ServiceId" class="form-label">
                        <i class="fas fa-concierge-bell"></i> Hizmet
                    </label>
                    <select asp-for="ServiceId" class="form-select" id="ServiceId">
                        @if (User.IsInRole("Admin"))
                        {
                            <option value="">-- Önce Salon Seçin --</option>
                        }
                        else if (User.IsInRole("Trainer"))
                        {
                            <option value="">-- Hizmet Seçin --</option>
                            @if (ViewBag.Services != null)
                            {
                                var services = ViewBag.Services as IEnumerable<ServiceViewModel>;
                                if (services != null)
                                {
                                    @foreach (var service in services)
                                    {
                                        <option value="@service.ServiceId">@service.Name - @service.Price.ToString("F2") TL</option>
                                    }
                                }
                            }
                        }
                    </select>
                    <span asp-validation-for="ServiceId" class="text-danger"></span>
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-times"></i> İptal
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Gym seçildiğinde services'i yükle
        document.getElementById('GymId')?.addEventListener('change', function() {
            const gymId = this.value;
            const serviceSelect = document.getElementById('ServiceId');
            
            if (!gymId) {
                serviceSelect.innerHTML = '<option value="">-- Önce Salon Seçin --</option>';
                return;
            }
            
            fetch(`/Services/GetByGym?gymId=${gymId}`)
            .then(response => response.json())
            .then(services => {
                serviceSelect.innerHTML = '<option value="">-- Hizmet Seçin --</option>';
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.serviceId;
                    option.textContent = `${service.name} - ${service.price.toFixed(2)} TL`;
                    serviceSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading services:', error);
                serviceSelect.innerHTML = '<option value="">Hizmetler yüklenemedi</option>';
            });
        });
    </script>
}
